<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Factura - Mañoco del Llano</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <h1>Factura Mañoco del Llano</h1>
  <form id="formularioFactura">
    <label>Cliente: <input type="text" id="cliente" required /></label><br />
    <label>Producto: <input type="text" id="producto" required /></label><br />
    <label>Cantidad: <input type="number" id="cantidad" required /></label><br />
    <label>Precio Unitario: <input type="number" id="precio" required /></label><br />
    <label>Formato:
      <select id="formato">
        <option value="pdf">PDF</option>
        <option value="png">PNG</option>
        <option value="jpg">JPG</option>
        <option value="word">Word</option>
      </select>
    </label><br />
    <button type="button" onclick="descargarFactura()">Descargar Factura</button>
  </form>

  <div id="factura" style="display:none; padding: 20px; border: 1px solid #ccc;">
    <h2>Factura Mañoco del Llano</h2>
    <p id="resumenFactura"></p>
  </div>

  <script>
    function generarNumeroFactura() {
      const actual = localStorage.getItem("ultimoNumeroFactura") || "1000";
      const nuevo = parseInt(actual) + 1;
      localStorage.setItem("ultimoNumeroFactura", nuevo);
      return nuevo;
    }

    function descargarFactura() {
      const cliente = document.getElementById("cliente").value;
      const producto = document.getElementById("producto").value;
      const cantidad = parseFloat(document.getElementById("cantidad").value);
      const precio = parseFloat(document.getElementById("precio").value);
      const formato = document.getElementById("formato").value;
      const total = cantidad * precio;
      const fecha = new Date().toLocaleString();
      const numeroFactura = generarNumeroFactura();

      document.getElementById("resumenFactura").innerText = `
        Factura #${numeroFactura}
        Cliente: ${cliente}
        Producto: ${producto}
        Cantidad: ${cantidad}
        Precio Unitario: $${precio.toLocaleString()}
        Total: $${total.toLocaleString()}
        Fecha: ${fecha}
      `;

      const factura = document.getElementById("factura");
      factura.style.display = "block";

      const opt = {
        filename: `Factura-${numeroFactura}.${formato === "word" ? "doc" : formato}`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };

      if (formato === "pdf") {
        html2pdf().set(opt).from(factura).save().then(() => {
          factura.style.display = "none";
        });
      } else {
        html2pdf().set(opt).from(factura).outputImg().then(img => {
          const link = document.createElement("a");
          link.download = opt.filename;
          link.href = img;
          link.click();
          factura.style.display = "none";
        });
      }

      guardarEnBaseDeDatos(cliente, producto, cantidad, precio, total, fecha, numeroFactura, formato);
    }

    function guardarEnBaseDeDatos(cliente, producto, cantidad, precio, total, fecha, numeroFactura, formato) {
      const nuevoRegistro = {
        numero: numeroFactura,
        cliente,
        producto,
        cantidad,
        precio,
        total,
        fecha,
        formato
      };

      const registros = JSON.parse(localStorage.getItem("datos")) || [];
      registros.push(nuevoRegistro);
      localStorage.setItem("datos", JSON.stringify(registros));
    }
  </script>
</body>
</html>
