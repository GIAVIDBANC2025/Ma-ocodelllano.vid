<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Generador de Facturas - Mañoco del Llano</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, select, button { padding: 8px; margin: 5px; }
    #factura { display: none; padding: 20px; border: 1px solid #ccc; background: #f9f9f9; }
  </style>
</head>
<body>
  <h1>Generador de Facturas</h1>
  <form id="formularioFactura">
    <input type="text" id="cliente" placeholder="Cliente" required />
    <input type="text" id="producto" placeholder="Producto" required />
    <input type="number" id="cantidad" placeholder="Cantidad" required />
    <input type="number" id="precio" placeholder="Precio Unitario" required />
    <select id="formato">
      <option value="pdf">PDF</option>
      <option value="png">PNG</option>
      <option value="jpg">JPG</option>
      <option value="word">Word</option>
    </select>
    <button type="button" onclick="descargarFactura()">Descargar y Guardar</button>
  </form>

  <div id="factura">
    <h2>Factura Mañoco del Llano</h2>
    <p id="resumenFactura"></p>
  </div>

  <script>
    function generarNumeroFactura() {
      const actual = localStorage.getItem("ultimoNumeroFactura") || "1000";
      const nuevo = parseInt(actual) + 1;
      localStorage.setItem("ultimoNumeroFactura", nuevo);
      return nuevo;
    }

    function descargarFactura() {
      const cliente = document.getElementById("cliente").value;
      const producto = document.getElementById("producto").value;
      const cantidad = parseFloat(document.getElementById("cantidad").value);
      const precio = parseFloat(document.getElementById("precio").value);
      const formato = document.getElementById("formato").value;
      const total = cantidad * precio;
      const fecha = new Date().toLocaleString();
      const numeroFactura = generarNumeroFactura();

      document.getElementById("resumenFactura").innerText = `
Factura #${numeroFactura}
Cliente: ${cliente}
Producto: ${producto}
Cantidad: ${cantidad}
Precio Unitario: $${precio.toLocaleString()}
Total: $${total.toLocaleString()}
Fecha: ${fecha}
      `;

      const factura = document.getElementById("factura");
      factura.style.display = "block";

      const opciones = {
        filename: `Factura-${numeroFactura}.${formato === "word" ? "doc" : formato}`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };

      if (formato === "pdf") {
        html2pdf().set(opciones).from(factura).save().then(() => {
          factura.style.display = "none";
        });
      } else {
        html2pdf().set(opciones).from(factura).outputImg().then(img => {
          const link = document.createElement("a");
          link.download = opciones.filename;
          link.href = img;
          link.click();
          factura.style.display = "none";
        });
      }

      guardarEnBaseDeDatos(cliente, producto, cantidad, precio, total, fecha, numeroFactura, formato);
    }

    function guardarEnBaseDeDatos(cliente, producto, cantidad, precio, total, fecha, numeroFactura, formato) {
      const nuevoRegistro = {
        numero: numeroFactura,
        cliente,
        producto,
        cantidad,
        precio,
        total,
        fecha,
        formato
      };

      const registros = JSON.parse(localStorage.getItem("datos")) || [];
      registros.push(nuevoRegistro);
      localStorage.setItem("datos", JSON.stringify(registros));
    }
  </script>

  <script>
function guardarFacturaEnBase(factura) {
  let existentes = JSON.parse(localStorage.getItem("datosFacturas")) || [];
  existentes.push(factura);
  localStorage.setItem("datosFacturas", JSON.stringify(existentes));
}

function registrarFacturaDescargada(formato, archivoURL) {
  const numeroFactura = document.getElementById("numeroFactura").value || generarNumeroFactura();
  const cliente = document.getElementById("nombreCliente").value || "Cliente sin nombre";
  const producto = document.getElementById("producto").value || "Producto";
  const cantidad = parseInt(document.getElementById("cantidad").value) || 1;
  const precio = parseFloat(document.getElementById("precio").value.replace(/\./g, '').replace(',', '.')) || 0;
  const total = cantidad * precio;
  const fecha = new Date().toLocaleString();

  guardarFacturaEnBase({
    numero: numeroFactura,
    cliente,
    producto,
    cantidad,
    precio,
    total,
    fecha,
    formato,
    archivo: archivoURL
  });
}

// Opcional: Si no tienes número automático
function generarNumeroFactura() {
  return Math.floor(Math.random() * 900000 + 100000).toString();
}
                                                                                               </script>
  
</body>
</html>
